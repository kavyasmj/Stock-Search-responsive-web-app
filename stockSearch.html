<!DOCTYPE HTML>
<html lang="en">
<head>
    
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- JQuery -->
<script   src="https://code.jquery.com/jquery-2.2.2.min.js"   integrity="sha256-36cp2Co+/62rEAAYHLmRCPIych47CvdM+uTBJwSzWjI="   crossorigin="anonymous"></script>
<!-- JQuery UI-->    
<script   src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"   integrity="sha256-xNjb53/rY+WmG+4L6tTl9m6PpqknWZvRt0rO1SRnJzw="   crossorigin="anonymous"></script>
    
<!-- BS Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
 <!-- BS Toggle minified CSS -->   
<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
       
<!-- BS Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<!-- BS Toggle minified JS-->  
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>   
<!-- Moment JS-->  
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js"></script>   
   
    
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
 <script src="https://code.highcharts.com/stock/highstock.js"></script>
    

<style type="text/css">
   body { 
       background: #1C5274 !important;
    }
    .well-lg{
       background-color:white !important; 
       margin-top:10px;
    } 
    hr{
        border-color: lightslategrey;
    }
    h4{
      text-align: center;
      font-size: 1.1em;
      font-weight: bold;
    }
    #logo{
        text-align: right;
    }
    #imglogo{
      height: 1.7em;
      width: 8em;
    }
    .btnclr{
        background-color: white;
        margin: 0px;
    }
    .smoke{
        background-color: whitesmoke;
    }
    rhs{
        text-align: right;
    }
    .nopadding {
        padding-bottom: 0;
    }

    ul.nav.nav-tabs li :active{
      color: white;
      background-color: blue;
    }
    #tab2{
     margin-top: 1em;
    }
    .navig{
        border-color: lightgray;
    }   

    #histTitle{
        text-align: center;
    }
    #currStkImg{
        width:100%;
        height:60%;
    }
    #btn-fb{
           background:url("fb.PNG") no-repeat ; 
           background-size: 100% 100%;
           width: 3.5em; 
           height:3.5em; 
           border: transparent;
        }
    #btn-star{
           background:url("star-white.PNG") no-repeat ;
           border: transparent;
           background-size: 100% 100%;
           width: 3.5em; 
           height:3.5em; 
           padding-right: 3.1em;
        }
    #error_quote{
        color:red;
        text-align: center;
    }

    .control-label:after{
     content:"*" ;
     color:red   
     }
    #chartContainer{
      width:80%;
    }
    @media (max-width: 800px) { 
        .btnspup{
            margin-top: 1em;
        }        
    }
    #favtext{
      font-weight: bold;
      font-size: 0.96em;
    }
</style>
</head>
    
<body>   
 <script>
       //<!--Facebook SDK for JS-->
      
          window.fbAsyncInit = function() {
            FB.init({
              appId      : '257669031238281',
              xfbml      : true,
              version    : 'v2.5'
            });
          };

          (function(d, s, id){
             var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "//connect.facebook.net/en_US/sdk.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));

</script>   

<!------------------------------------------------------HTML--------------------------------------------------------------->
<div class="container">
  
    <div class="well well-lg">
        <form>
        <h4>Stock Market Search</h4> 
            
        <div class="row">
            <div class="col-sm-3">
                <label for="sym" class="control-label required" >Enter the stock name or symbol:</label> 
            </div>
            <div class="col-sm-6">
                 <input type="text" name="sym" id="sym" class="form-control required" placeholder="Apple Inc or APPL" required="true">

            </div>
            <div class="col-sm-3">
                <button type="submit" name ="search" id="search" class="btnspup btn btn-primary btn-md" ><span class="glyphicon glyphicon-search"></span> Get Quote </button>  
                 <button type="button" name="clear" id="clear" class="btnspup btn btn-default smoke"><span class="glyphicon glyphicon-refresh"></span> Clear</button>
            </div>
        </div>
        <br/>
        <div class="row">
            <div class="col-sm-3">
            </div>
            <div class="col-sm-6">
                <span id="error_quote"></span>
            </div>
            <div class="col-sm-3">            
                <span  id="logo">Powered By: <a href="http://dev.markitondemand.com/MODApis/." alt="Mod APIs" target="_blank"><img id="imglogo" src='http://cs-server.usc.edu:45678/hw/hw8/images/mod-logo.png' ></a></span>
            </div>
        </div>
        </form>
    </div>
    <hr/>
    
    <div id="myCarousel" class="carousel slide" data-interval="false">
    <!-- Inside slides -->
    <div class="carousel-inner" role="listbox">
      <div class="item active">
          
              <div class="well well-lg">                 
                <div class="panel panel-default">
                    <div class="panel-heading clearfix">
                      <div class="panel-title pull-left" id="favtext">Favorite List </div>
                      <div class="pull-right">
                         <span class="hidden-xs">Automatic Refresh:</span>
                        <span title="Refresh every 5 seconds">
                        <input type="checkbox" id="tog" data-toggle="toggle"></span>
                        <button type="button" class="btnclr btn btn-default" id="btn-ref" title="Refresh" onclick="refresh_data()"><span class="glyphicon glyphicon-refresh"/></button>
                        <button type="button" class="btnclr btn btn-default right" id="right" href="#myCarousel" role="button" data-slide="next" title="Stock Details"><span class="glyphicon glyphicon-chevron-right"/></button>

                      </div>
                    </div>

                    <div class="panel-body">     
                        <div class="table-responsive">
                            <table class="table table-striped" id="tab">
                                <tbody>
                                  <tr>
                                    <th>Symbol</th>
                                    <th>Company Name</th>
                                    <th>Stock Price</th>
                                    <th>Change(Change Percent)</th>
                                    <th>Market Cap</th>
                                    <th></th>
                                  </tr> 
                                </tbody>
                            </table>
                         </div>
                   </div>
                </div>
            </div>

      </div>

      <div class="item">
        <div class="well well-lg">
            <div class="panel panel-default " >
                <div class="panel-heading clearfix nopadding">
                      <div class="pull-left">
                        <button type="button" class="btnclr btn btn-default left" href="#myCarousel" data-slide="prev" role="button" id="left" ><span class="glyphicon glyphicon-chevron-left"/></button>
                      </div>
                    <h4 class=text-center> Stock Details</h4>
                </div>
            </div>
            
            <div class="panel-body">

                <div id = "tabs">
                <!-- Nav tabs -->
                <ul class="nav nav-pills">
            
                  <li class="active hidden-xs"><a href="#stock" data-toggle="tab"><span class="glyphicon glyphicon-dashboard">Current Stock</span></a></li>
                  <li class="active hidden-md hidden-sm hidden-lg"><a href="#stock" data-toggle="tab"><span class="glyphicon glyphicon-dashboard">Stock</span></a></li>
                  <li class="hidden-xs"><a href="#hist" data-toggle="tab"><span class="glyphicon glyphicon-stats"/>Historical Charts</a></li>
                  <li class="hidden-md hidden-sm hidden-lg"><a href="#hist" data-toggle="tab"><span class="glyphicon glyphicon-stats"/>Charts</a></li>
                  <li class="hidden-xs"><a href="#news" data-toggle="tab"><span class="glyphicon glyphicon-link"/>News Feeds</a></li>
                  <li class="hidden-md hidden-sm hidden-lg"><a href="#news" data-toggle="tab"><span class="glyphicon glyphicon-link"/>News</a></li>
                </ul>
                
                <hr/ class="navig">
                    
                <!-- Tab panes -->
                    
                <div class="tab-content">
                  <div class="tab-pane fade in active" id="stock">    
                        <p id="tab2">Stock Details
                    <button type="button" id="btn-star" class="btn btn-default pull-right"></button>
                    <button type="button" id="btn-fb" class="btn btn-default pull-right"></button>
                    </p>
                      <div class="row">
                        <div class="col-sm-6">
<!--                              <p id="tab2">Stock Details</p>-->
                              <div class="table-responsive">
                              <table class="table table-striped">
                                <tbody id="tbody_stock">
                                  <tr>
                                    <th>Name</th>
                                    <td id="stk_name" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>Symbol</th>
                                    <td id="stk_sym" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>Last Price</th>
                                    <td id="stk_lastp" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>Change(Change Percent)</th>
                                    <td id="stk_chp" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>Time and Date</th>
                                    <td id="stk_td" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>Market Cap</th>
                                    <td id="stk_mc" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>Volume</th>
                                    <td id="stk_vol" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>Change YTD(Change Percent YTD)</th>
                                    <td id="stk_chp_ytd" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>High Price</th>
                                    <td id="stk_hp" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>Low Price</th>
                                    <td id="stk_lp" class="stock_tab"></td>
                                  </tr>
                                  <tr>
                                    <th>Opening Price</th>
                                    <td id="stk_op" class="stock_tab"></td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                        </div>
                          
                        <div class="col-sm-6"> 
                              <p id="ychart"></p>
                        </div>
                          
                      </div>                     
                  
                  </div>
                    
                  <div class="tab-pane" id="hist">
                       <div id="chartContainer">
                      </div>
                  <hr/ class="navig">
                  </div>
                    
                  <div class="tab-pane" id="news">
                  </div>
                    
                </div>
                </div>
        
            </div> 
      </div>
     </div>
        
<!-------------------------------------------------JS------------------------------------------------------------->
 <script type="text/javascript">
     
    
      
    var url;
    var link_green_arrow = "<img src='http://cs-server.usc.edu:45678/hw/hw8/images/up.png'>";
    var link_red_arrow = "<img src='http://cs-server.usc.edu:45678/hw/hw8/images/down.png'>";
    
    var ychart1 = "<img src='";
    var ychart2 = "http://chart.finance.yahoo.com/t?s=";
    var ychart3 = "&lang=en-US";
    var ychart4 = "&width=500&height=320' id='currStkImg'>";
     
    var error_msg_inval = "Invalid symbol";
    var error_msg_norec = "No records found";

    var name;  
    var symbol;
    var lp;   
    var chpString;
    var chpStr;
    var mc;
    var inp;
 
     
    function refresh_data(){
        
        $("tr.item").each(function() {
            $this = $(this)
            var value = $this.attr("id");
              
            var val_url = "http://php571server-env.us-west-2.elasticbeanstalk.com/?sym=".concat(value);

            $.ajax({
                  type: "GET",
                  url: val_url,
                  success: function(val_data){
                          try{
                              var val_parsedData = JSON.parse(val_data); 
                          }
                          catch(e){
                             return;
                          }
                           
                          var val_name        = val_parsedData.Name;
                          var val_lp          = val_parsedData.LastPrice;
                          var val_mc          = val_parsedData.MarketCap;
                          var val_chpStr      = val_parsedData.Str;
                          var val_chngPer     = val_parsedData.ChangePercent;
                          var val_chpString   = val_chpStr;
                                                 
                          var val_cell_id_chp_jq = '#'.concat(value).concat("_tr");
                          var val_cell_id_chp = value.concat("_tr"); 
                          var val_cell_id_sp = value.concat("_tr_sp"); 
                          var val_cell_id_mc = value.concat("_tr_mc"); 
                      

                          ( val_chngPer < 0 
                              ? (val_chpString = val_chpStr.concat(link_red_arrow))
                              : (val_chngPer > 0 
                                  ? ( val_chpString = val_chpStr.concat(link_green_arrow)) : '')) ; 
                      

                          document.getElementById(val_cell_id_sp).innerHTML     = val_lp;
                          document.getElementById(val_cell_id_chp).innerHTML    = val_chpString; 
                      
                          if(val_chngPer < 0){
                              $(val_cell_id_chp_jq).css({'color':'red'});
                          } 
                          else if(val_chngPer > 0){
                              $(val_cell_id_chp_jq).css({'color':'green'});
                          }
                          else{
                              $(val_cell_id_chp_jq).css({'color':'black'});
                          }
                     
                }
                ,
                error: function(){
                    alert("Fail");
                }
            });    
            
            

        });
        
    }
     
    function call_stock(element){
        inp = element.id;
        get_quote();
    } 
    function get_quote(){
        $('#error_quote').html("");
        
            url = "http://php571server-env.us-west-2.elasticbeanstalk.com/?sym=".concat(inp);
            $.ajax({
                  type: "GET",
                  url: url,
                  success: function(data){
                      if(data === "INVALID"){
                          $('#error_quote').html(error_msg_inval);  
                      }
                      else if(data === "NOREC"){
                          $('#error_quote').html(error_msg_norec);
                      }
                      else{
                          try{
                              var parsedData = JSON.parse(data); 
                          }
                          catch(e){
                              $('#error_quote').html(error_msg_inval);
                              inp = "";
                              return;
                          }
                                      
                            if(parsedData.Status =="SUCCESS"){
                                    name        =parsedData.Name;
                                    symbol      =parsedData.Symbol;
                                    lp          =parsedData.LastPrice;
                                var chng        =parsedData.Change;
                                var chngPer     =parsedData.ChangePercent;
                                    chpStr      =parsedData.Str;
                                var ts          =parsedData.Timestamp;
                                    mc          =parsedData.MarketCap;
                                var vol         =parsedData.Volume;
                                var chngYTD     =parsedData.ChangeYTD;
                                var chngPerYTD  =parsedData.ChangePercentYTD;
                                var ytdStr      =parsedData.YTDStr;
                                var high        =parsedData.High;
                                var low         =parsedData.Low;
                                var open        =parsedData.Open;
                                                
                                ts_new = moment(ts).format('DD MMMM YYYY, hh:mm:ss A');                
                                chpString = chpStr;

                                if(chngPer < 0){
                                    $("#stk_chp").css({'color':'red'});
                                } 
                                else if(chngPer > 0){
                                    $("#stk_chp").css({'color':'green'});
                                }
                                else{
                                    $("#stk_chp").css({'color':'black'});
                                }

                                ( chngPer < 0 
                                    ? (chpStr = chpStr.concat(link_red_arrow))
                                    : (chngPer > 0 
                                        ? ( chpStr = chpStr.concat(link_green_arrow)) : '')) ;    

                                 if(chngPerYTD < 0){
                                     $("#stk_chp_ytd").css({'color':'red'});
                                 } 
                                 else if(chngPerYTD > 0){
                                     $("#stk_chp_ytd").css({'color':'green'});
                                 }
                                 else{
                                     $("#stk_chp_ytd").css({'color':'black'});
                                 }

                                ( chngPerYTD < 0 
                                    ? (ytdStr = ytdStr.concat(link_red_arrow))
                                    :(chngPerYTD > 0 
                                        ? ( ytdStr = ytdStr.concat(link_green_arrow)): '')) ;

                                document.getElementById("stk_name").innerHTML   = name;
                                document.getElementById("stk_sym").innerHTML    = symbol;
                                document.getElementById("stk_lastp").innerHTML  = lp;
                                document.getElementById("stk_chp").innerHTML    = chpStr; 
                                document.getElementById("stk_td").innerHTML     = ts_new;
                                document.getElementById("stk_mc").innerHTML     = mc;
                                document.getElementById("stk_vol").innerHTML    = vol;
                                document.getElementById("stk_chp_ytd").innerHTML= ytdStr;
                                document.getElementById("stk_hp").innerHTML     = high;
                                document.getElementById("stk_lp").innerHTML     = low;
                                document.getElementById("stk_op").innerHTML     = open;

                                var ychart = ychart1.concat(ychart2).concat(symbol).concat(ychart3).concat(ychart4);
                                document.getElementById("ychart").innerHTML     = ychart;
                                
                                var local_store_check = localStorage.getItem(symbol);
                                if(local_store_check === null)
                                {
                                    $("#btn-star").css({'background':'url("star-white.PNG") no-repeat'});
                                }
                                else{
                                    
                                    $("#btn-star").css({'background':'url("star-yel.PNG") no-repeat'});
                                }
                                
                                document.getElementById("right").disabled = false;
                                get_chart();
                                get_news();
                                    
                            }
                      }
                      $('#myCarousel').carousel(1);                      
                }
                ,
                error: function(){
                    alert("Fail");
                }
            });

    }
     
    $("#search").click(function(e){
        inp = $('#sym').val().toUpperCase();
        
        if(inp != ''){
            e.preventDefault(); //incase get is empty, html5 validation should be triggered   
            get_quote();
          }  
    });
     
//////----------------------------------------------news---------------------------------------------------
    
    function get_news(){
        
        if(inp != ''){
            var gnews = "http://php571server-env.us-west-2.elasticbeanstalk.com/?symb=".concat(inp);
            var error_msg = '<div class="well err">'.concat("Sorry, could not retrieve the news feed. Please try again later.").concat('</div>');

            $.ajax({
                beforeSend:function(){
                    $("#news").text("Loading news...");
                },
                  type: "GET",
                  url: gnews,
                  success: function(dat){
                      if(dat === "ERROR"){
                          $('#news').html(error_msg);   
                      }
                      else{
                          var parsedDat = JSON.parse(dat);
                          var well_str;
                          var well_sup_str = '';

                            $.each(parsedDat, function(i, item) {

//                                var uurl        =item.unescapedUrl;
//                                var tnf         =item.titleNoFormatting;
//                                var con         =item.content;
//                                var pub         =item.publisher;
//                                var pdate       =item.publishedDate;
                                
                                var uurl        =item.URL;
                                var tnf         =item.Title;
                                var con         =item.Description;
                                var pub         =item.Source;
                                var pdate       =item.Date;
                                

                                var well_str = '<div class="well succ"><a href="'.concat(uurl)
                                .concat('">').concat(tnf).concat('</a>')
                                .concat('<p>').concat(con).concat('</p>')
                                .concat('<p><strong>Publisher: ').concat(pub).concat('</strong></p>')
                                .concat('<p><strong>Date: ').concat(pdate).concat('</strong></p></div>');

                                well_sup_str = well_sup_str.concat(well_str);      
                                $('#news').html(well_sup_str);
                        });
                      }          
                  }
                  ,
                  error: function(){
                      alert("Fail");
                  }
            });
        }
        else{
            $('#error_quote').html("Please enter an input");
        }
    }
//----------------------------ready function-----------------------------------     
 $(function() {
     
    jQuery("#tog[title]").tooltip();
    update_tab();
     
    $('#right').prop('disabled', true);
     
    $( "#sym" ).autocomplete({
      source: function( request, response ) {
        $.ajax({
          url: "http://dev.markitondemand.com/api/v2/Lookup/jsonp",
          dataType: "jsonp",
          data: {
            input: request.term
          },
          success: function( data ) {
            
				response( $.map(data, function(item) {
					return {
						label: item.Symbol + " - " +  item.Name + "(" +item.Exchange+ ")",
						value: item.Symbol
					}
				}));
          }
        });
      },
      minLength: 1,
    });
 
     
  });
 //----------------------------update tab function-----------------------------------     
  function update_tab()
  {
     var dyn_fav_tab;     
     for(var i=0; i<localStorage.length; i++) {
         
         var key = localStorage.key(i);   

         var url1 = "http://php571server-env.us-west-2.elasticbeanstalk.com/?sym=".concat(key);
            $.ajax({
                  type: "GET",
                  url: url1,
                  success: function(data1){
                     
                        var parsedData1 = JSON.parse(data1); 

                        var name1        =parsedData1.Name;
                        var symbol1      =parsedData1.Symbol;
                        var lp1          =parsedData1.LastPrice;
                        var chpStr1      =parsedData1.Str;
                        var mc1          =parsedData1.MarketCap; 
                        var chngPer1     =parsedData1.ChangePercent;

                        ( chngPer1 < 0 
                            ? (chpStr1 = chpStr1.concat(link_red_arrow))
                            : (chngPer1 > 0 
                                ? ( chpStr1 = chpStr1.concat(link_green_arrow)) : '')) ;   
                      
                         var tr_id = symbol1.concat("_tr");
                         dyn_fav_tab= '<tr class="item" id="'.concat(symbol1).concat('"><td>');
                         dyn_fav_tab = dyn_fav_tab.concat('<a id="').concat(symbol1).concat('" href="javascript:void(0);" onclick="call_stock(this);">').concat(symbol1).concat('</td><td>'); 
                      
                         dyn_fav_tab = dyn_fav_tab.concat(name1).concat('</td><td id="').concat(tr_id).concat("_sp").concat('" >'); 
                         dyn_fav_tab = dyn_fav_tab.concat(lp1).concat('</td><td id="').concat(tr_id).concat('" >') ;
                         dyn_fav_tab = dyn_fav_tab.concat(chpStr1).concat('</td><td id="').concat(tr_id).concat("_mc").concat('" >'); 
                         dyn_fav_tab = dyn_fav_tab.concat(mc1).concat('</td>');
                         dyn_fav_tab = dyn_fav_tab.concat('<td><button id="').concat(symbol1).concat('" type="button" class="btn btn-default btn-trash" onclick="delete_row(this.id)"><span class="glyphicon glyphicon-trash"/></button></td></tr>');
                         $('#tab > tbody:last-child').append(dyn_fav_tab);
                         
                         dyn_fav_tab ='';


                         tr_id = '#'.concat(tr_id);

                         if(chngPer1 > 0){
                             $(tr_id).css({'color':'green'});
                         } 
                         else if (chngPer1 < 0){
                             $(tr_id).css({'color':'red'});
                         }

                }
            });
        }  
  }   
   
//<!--Begin Facebook Share Dialog Implementation-->
  $('#btn-fb').click( function(){
  
      var cap = 'Current Stock Price of '.concat(name).concat('is ').concat(lp);      
      var desc1 = 'Stock Information of '.concat(name).concat(' (').concat(symbol).concat(' )');
      var desc2 = ' LAST TRADED PRICE: '.concat(lp).concat(', CHANGE: ' ).concat(chpString);
      
      var desc = desc1.concat(desc2);       
      var pict = ychart2.concat(symbol).concat(ychart3).concat('&width=185&height=170'); 
      
          window.fbAsyncInit = function() {
            FB.init({
              appId      : '257669031238281',
              xfbml      : true,
              version    : 'v2.5'
            });
          };

          (function(d, s, id){
             var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "//connect.facebook.net/en_US/sdk.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));

            FB.ui({
              method: 'share',
              appId: '257669031238281',
              title: cap,
              href: 'http://dev.markitondemand.com/MODApis/',
              caption: desc2,
              description: desc1,
              picture:pict,

            }, function(response){
                if (response && !response.error_code) {
                    alert('Posted Successfully');
                } 
                else {
                    alert('Not Posted');
                }
            });
  });  
 //<!--End of Facebook Share Dialog Implementation-->       
    
  $('#clear').click(function(){
      
        inp='';
        $('#sym').val("");
        $('#error_quote').html("");
        $('#myCarousel').carousel(0);
        $(".stock_tab").empty();
        $("#ychart").empty();
        $(".err").remove();  
        $(".succ").remove();  

        $("#btn-star").css({'background':'url("star-white.PNG") no-repeat'});
        $('#right').prop('disabled', true);
      
//        $('.nav-pills a[href="#stock"]').trigger('click'); apparently not needed - as selection must be retained
  });
     
     
 $("#btn-star").click( function()
     {    
          var res = symbol.toUpperCase();
          var local_store_check = localStorage.getItem(res);
          if(local_store_check === null) //favorite
          {
                localStorage.setItem(res, JSON.stringify(res));
                  var tr_id = res.concat("_tr");

                 //update in table
                 dyn_fav_tab = '<tr class="item" id="'.concat(res).concat('"><td>');              
                 dyn_fav_tab = dyn_fav_tab.concat('<a id="').concat(res).concat('" href="#" onclick="call_stock(this);">').concat(res).concat('</td><td>');
              
                 dyn_fav_tab = dyn_fav_tab.concat(name).concat('</td><td id="').concat(tr_id).concat("_sp").concat('" >'); 
                 dyn_fav_tab = dyn_fav_tab.concat(lp).concat('</td><td id="').concat(tr_id).concat('" >') ;
                 dyn_fav_tab = dyn_fav_tab.concat(chpStr).concat('</td><td id="').concat(tr_id).concat("_mc").concat('" >'); 
                 dyn_fav_tab = dyn_fav_tab.concat(mc).concat('</td>');
                 dyn_fav_tab = dyn_fav_tab.concat('<td><button id="').concat(res).concat('" type="button" class="btn btn-default btn-trash" onclick="delete_row(this.id)"><span class="glyphicon glyphicon-trash"/></button></td></tr>');
                 $('#tab > tbody:last-child').append(dyn_fav_tab);
              
                 dyn_fav_tab ='';
              
                 $("#btn-star").css({'background':'url("star-yel.PNG") no-repeat'});
              
                 tr_id = '#'.concat(tr_id);
         
                 if(chpStr.indexOf('down') == -1){
                     $(tr_id).css({'color':'green'});
                 } 
                 else{
                     $(tr_id).css({'color':'red'});
                 }
          }
          else{//unfavorite
                delete_row(res);              
          }          
     }
   );
     
    function delete_row(id)
  {
      localStorage.removeItem(id);
//      $("#tab").find("tr:gt(0)").remove();
      var tr_id = '#'.concat(id);
      $(tr_id).remove();
//      update_tab();
     
      $("#btn-star").css({'background':'url("star-white.PNG") no-repeat'});
  }
     
////----------------------------automatic refresh-----------------------------------  
var interval_id;
$('#tog').change(function() {
    if($(this).is(":checked")) {
       interval_id = window.setInterval(function(){ refresh_data(); }, 5000);
    } 
    else{
        window.clearInterval(interval_id );
    }
});
 
////----------------------------historical charts-----------------------------------      

fixDate = function(dateIn) {
    var dat = new Date(dateIn);
    return Date.UTC(dat.getFullYear(), dat.getMonth(), dat.getDate());
};
    
getInputParams = function(){

    return {  
        Normalized: false,
        NumberOfDays: 1095,
        
        DataPeriod: "Day",
        Elements: [
            {
//                Symbol: stock_symbol,
                Symbol: inp,
                Type: "price",
                Params: ["ohlc"] //ohlc, c = close only
            },
        ]
    }
};
    
getOHLC = function(json) {
    var dates = json.Dates || [];
    var elements = json.Elements || [];
    var chartSeries = [];

    if (elements[0]){

        for (var i = 0, datLen = dates.length; i < datLen; i++) {
            var dat = fixDate( dates[i] );
            var pointData = [
                dat,
                elements[0].DataSeries['open'].values[i],
                elements[0].DataSeries['high'].values[i],
                elements[0].DataSeries['low'].values[i],
                elements[0].DataSeries['close'].values[i]
            ];
            chartSeries.push( pointData );
        };
    }
    return chartSeries;    
};  
    
render = function(data) {
    // split the data set into ohlc 
    var ohlc = getOHLC(data);
    
    // set the allowed units for data grouping
    var groupingUnits = [[
        'week',                         // unit name
        [1]                             // allowed multiples
    ], [
        'month',
        [1, 2, 3, 4, 6]
    ]];
    
    // create the chart
    $('#chartContainer').highcharts('StockChart', {
    
         rangeSelector: {
                inputEnabled: false,
                buttons: [ {
                    type: 'week',
                    count: 1,
                    text: '1w'
                }, {
                    type: 'month',
                    count: 1,
                    text: '1m'
                },{
                    type: 'month',
                    count: 3,
                    text: '3m'
                }, {
                    type: 'month',
                    count: 6,
                    text: '6m'
                }, {
                    type: 'year',
                    count: 1,
                    text: '1y'
                }, {
                    type: 'all',
                    text: 'All'
                }],
                selected: 0
            },

        title: {
//            text: stock_symbol + ' Historical Price'
            text: inp + ' Historical Price'
        },

        yAxis: [{
            title: {
                text: 'Stock Value'
            },
            height: 200,
            lineWidth: 2
        }],
        xAxis: [{
            title: {
                text: 'Date Time'
            }
        }],
//        credits: {
//            enabled:false
//        },
        series : [{
                data : ohlc,
                type : 'area',
                threshold : null,
                dataGrouping: {
                units: groupingUnits
            },
                tooltip : {
                    valueDecimals : 2,
                    valuePrefix: '$'
                },
                fillColor : {
                    linearGradient : {
                        x1: 0,
                        y1: 0,
                        x2: 0,
                        y2: 1
                    },
                    stops : [
                        [0, Highcharts.getOptions().colors[0]],
                        [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                    ]
                }
            }]


    });

};     

     
function get_chart(){
//        var stock_symbol = $('#sym').val().toUpperCase();
        var params = {
        parameters: JSON.stringify( getInputParams() )
            
    }
        
        //Make JSON request for timeseries data
    $.ajax({
        beforeSend:function(){
            $("#chartContainer").text("Loading chart...");
        },
        data: params,
        url: "http://dev.markitondemand.com/Api/v2/InteractiveChart/jsonp",
        dataType: "jsonp",
        context: this,  
        success: function(json){
            //Catch errors
            if (!json || json.Message){
                console.error("Error: ", json.Message);
                return;
            }
            render(json);
        },
        error: function(response,txtStatus){
            console.log(response,txtStatus)
        }
    });
}
     
</script>
   
<noscript>
</noscript>
</body>
</html>